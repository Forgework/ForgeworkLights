"""
Animations Panel - Select and apply LED animations with parameters
"""
from textual.widgets import Static
from textual.containers import Vertical, Horizontal
from textual.reactive import reactive
from textual.app import ComposeResult
from textual.message import Message
from textual import events
import json
from pathlib import Path
from ..animations import ANIMATIONS, ANIMATIONS_LIST
from ..constants import CONFIG_DIR


class AnimationsPanel(Static):
    """
    Panel for selecting LED animations with parameter controls
    """
    
    class AnimationSelected(Message):
        """Message when an animation is selected"""
        def __init__(self, animation_name: str, params: dict):
            super().__init__()
            self.animation_name = animation_name
            self.params = params
    
    selected_animation = reactive("static")
    focused_index = reactive(0)
    param_focus = reactive(-1)  # -1 = list focused, >= 0 = param focused
    
    # Animation parameters file
    PARAMS_FILE = CONFIG_DIR / "animation-params.json"
    
    # Available animations
    ANIMATIONS_LIST = ANIMATIONS_LIST
    animation_params = {}
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.can_focus = True
    
    def compose(self) -> ComposeResult:
        """Compose the animations list"""
        with Vertical(id="animations-content"):
            yield Static("", id="animations-list")
    
    def on_mount(self) -> None:
        """Initialize display and load current animation"""
        from ..constants import ANIMATION_FILE
        
        # Load current animation from config file
        if ANIMATION_FILE.exists():
            self.selected_animation = ANIMATION_FILE.read_text().strip()
        
        self._update_display()
    
    def _update_display(self) -> None:
        """Update the animations list display"""
        lines = []
        
        for idx, (anim_id, anim_name) in enumerate(self.ANIMATIONS):
            # Selection indicator
            if anim_id == self.selected_animation:
                arrow = "â–¶"
            else:
                arrow = " "
            
            # Focus indicator
            if idx == self.focused_index and self.has_focus:
                # Focused item - highlighted in yellow (matching app style)
                line = f"[bold #f9e2af]{arrow} {anim_name}[/]"
            elif anim_id == self.selected_animation:
                # Selected but not focused - green
                line = f"[#a6e3a1]{arrow} {anim_name}[/]"
            else:
                # Normal item - muted text
                line = f"[#6c7086]{arrow}[/] [#cdd6f4]{anim_name}[/]"
            
            lines.append(line)
        
        # Update display
        animations_list = self.query_one("#animations-list", Static)
        animations_list.update("\n".join(lines))
    
    def on_key(self, event: events.Key) -> None:
        """Handle keyboard navigation"""
        if event.key == "up":
            self.focused_index = max(0, self.focused_index - 1)
            self._update_display()
            event.prevent_default()
        elif event.key == "down":
            self.focused_index = min(len(self.ANIMATIONS) - 1, self.focused_index + 1)
            self._update_display()
            event.prevent_default()
        elif event.key == "enter":
            # Select the focused animation
            anim_id, anim_name = self.ANIMATIONS[self.focused_index]
            self.selected_animation = anim_id
            self._update_display()
            self.post_message(self.AnimationSelected(anim_id))
            event.prevent_default()
    
    def on_focus(self, event: events.Focus) -> None:
        """Update display when focused"""
        self._update_display()
    
    def on_blur(self, event: events.Blur) -> None:
        """Update display when focus lost"""
        self._update_display()
    
    def watch_selected_animation(self, new_value: str) -> None:
        """React to selection changes"""
        self._update_display()
    
    def watch_focused_index(self, new_value: int) -> None:
        """React to focus changes"""
        self._update_display()
    
    def on_click(self, event) -> None:
        """Handle clicks on animation items"""
        # Calculate which line was clicked
        y = event.y
        
        if 0 <= y < len(self.ANIMATIONS):
            # Clicked on an animation
            anim_id, anim_name = self.ANIMATIONS[y]
            self.focused_index = y
            self.selected_animation = anim_id
            self._update_display()
            self.post_message(self.AnimationSelected(anim_id))
